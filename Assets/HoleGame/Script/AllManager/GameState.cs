using Lean.Gui;
using Lean.Transition.Method;
using System;
using System.Collections;
using System.Collections.Generic;

using UnityEngine;




public class GameState : MonoBehaviour
{
    public static GameState Instance { get; private set; }

  
    [SerializeField]
    private UFOPlayer ufoplayer;

    [SerializeField]
    private ObjectManager objectManager;

    [SerializeField]
    private CameraShake Camerashake;

    [SerializeField]
    private PlayerHudWidget PlayerHud;
 
    [SerializeField]
    private SkillManager AllSkillManager;

    // 총 남은 시간(초), float으로 관리
    [SerializeField]
    private float TotalTime = 30.0f;
    //private bool bIsTimeStop = false;
    Coroutine GameTimeCoroutine;
    Coroutine PlayTimeCoroutine;
    public event Action<int /*TotalSecound*/> FOnTotalTimeChanged;
 
    public float TotalPlayTime { get; private set; } = 0.0f;

 
    private int TotalScore = 0;
   
    private bool bIgnoredbomb = false;
    private bool bIceActive = false;
    
    private bool bIsGameEnd = false; 


    public Vector3 GetPlayerPostion() { return ufoplayer.transform.position; }

    public int GetPlayerCurrentLevel() { return ufoplayer.CurrentLevel; }

    public int StarCnt { get; private set; } = 0;


    private void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
        }
        else
        {
            Destroy(gameObject);
            return;
        }

    }

    void Start()
    {
        
        //보너스 목표 위젯 생성 
        objectManager.FOnBounsWidgetCreated += PlayerHud.CallBack_CreateShapeWidget;

        //보너스 목표 위젯 흡수 , 파괴 시 아이콘 생성
        objectManager.FOnBonusSwallowed += PlayerHud.CallBack_SpawnUIImageAtWorldPos;

        //오브젝트 빨아들였을때 바인딩
        objectManager.FOnObjectSwallowed += CallBack_ObjectSwallow;
        
        //장애물 빨아들였을때
        objectManager.FOnBomnbSwallowed += CallBack_BombSwallow;

        //보너스 목표 클리어 했을때 바인딩
        objectManager.FOnBounusCompleted += CallBack_BonusClear;

        //보너스 목표 시대 변경되서 강제 갱신 바인딩
        objectManager.FOnGenerationChanged += CallBack_ChangeGeneration;

        //보너스 위젯 클리어 애니메이션 끝났을때
        PlayerHud.FOnAllBounusAnimEnded += objectManager.CallBack_RenewalBonusObject;

        //재화 스폰 이벤트 바인딩
        objectManager.FOnStartSpawned += CallBack_StarSpawned;

        //온도계 위젯 바인딩
       // objectManager.FOnGenerationDataSeted += PlayerHud.CallBack_SetThermometerWidget;
        //ufoplayer.FOnExpGagueAdded += PlayerHud.CallBack_AddEXPThermometerWidget;



        //스킬 세팅
        AllSkillManager.SetSkill(ufoplayer);
        //스킬 표시
        foreach (SkillBase skilldata in AllSkillManager.ReadAllSkills)
        {

            PlayerHud.CreateSkillWidget(skilldata, AllSkillManager);
        }

        //스킬 바인딩
        AllSkillManager.FOnSkillActivated += PlayerHud.ActiveSkill;

        //스타 카운트 초기화 0 으로
        PlayerHud.ChangeStarCntText(StarCnt);

        //감지 위젯 플레이어 세팅
        PlayerHud.SetDetectStandardTarget(ufoplayer);

        //현재 시대 이름 세팅
        PlayerHud.ChangeGenerationNameText(objectManager.getCurrentGenerationName());   

        PlayerHud.SetTimeWidget(TotalTime,this);
        StartPlayTimer();
        StartGameTimer();
        PlayerHud.SetScoreText(TotalScore);

        objectManager.InitObjectManager(this);

       

    }

    private void OnDisable()
    {
        objectManager.FOnBounsWidgetCreated -= PlayerHud.CallBack_CreateShapeWidget;
        objectManager.FOnBonusSwallowed -= PlayerHud.CallBack_SpawnUIImageAtWorldPos;
        objectManager.FOnBounusCompleted -= CallBack_BonusClear;
        objectManager.FOnObjectSwallowed -= CallBack_ObjectSwallow;
        objectManager.FOnBomnbSwallowed -= CallBack_BombSwallow;

        AllSkillManager.FOnSkillActivated -= PlayerHud.ActiveSkill;
        PlayerHud.FOnAllBounusAnimEnded -= objectManager.CallBack_RenewalBonusObject;
        //ufoplayer.FOnExpGagueAdded -= PlayerHud.CallBack_AddEXPThermometerWidget;
    }

    private void CallBack_ObjectSwallow(FallingObject fallingobject)
    {

        //Debug.Log("흡수함");
        TotalScore += fallingobject.Score;
        TotalTime += fallingobject.TimeCnt;

        PlayerHud.SetScoreText(TotalScore);

        ufoplayer.AddEXPGauge(fallingobject.TimeCnt, fallingobject.ObjectMass);
      
    }

    private void CallBack_BonusClear(Dictionary<ShapeEnum, int> allbouns , int currentgeneration)
    {
        //Debug.Log("보너스 점수 추가 ");
        foreach (var item in allbouns)
        {
            for(int i = 0; i < item.Value;i++)
            {
                float timecnt = objectManager.SearchShapeData(item.Key, currentgeneration);

                TotalScore += (int)(timecnt * 100.0f) * (1 + currentgeneration) * 2;
               
            }
         
        }
    }
    private void CallBack_BombSwallow(float minustime)
    {
       
        TotalTime -= minustime;
        Camerashake.ShakeCamera();
    }

    public void CallBack_BossSpawned(BossObject boss)
    {
        if(ufoplayer!=null)
        {
            ufoplayer.SetCurrentBoss(boss);
        }
    }

    public void CallBacK_BossSwallow(BossObject bossObject)
    {
        CallBack_ObjectSwallow(bossObject);
    }



    public void StartGameTimer()
    {
        GameTimeCoroutine = StartCoroutine(GameTimerCount());
        
    }

    public void StartPlayTimer()
    {
        PlayTimeCoroutine = StartCoroutine(PlayTimerCount());
    }

    // 게임 진행 타이머: 매 프레임 Time.deltaTime 만큼 감소
    IEnumerator GameTimerCount()
    {
        // 코루틴 시작 시 초기 초 값 저장 (Floor)
        int lastSecond = Mathf.CeilToInt(TotalTime);
       

        while (TotalTime > 0f)
        {
            yield return null;

           
            // 남은 시간 감소
            TotalTime -= Time.deltaTime;
            if (TotalTime < 0f)
            {
                TotalTime = 0f;
            }

            // 현재 남은 초 (정수) 계산
            int currentSecond = Mathf.CeilToInt(TotalTime);
            // 만약 이전 프레임과 초가 달라졌다면 이벤트 호출
            if (currentSecond != lastSecond)
            {
                
                lastSecond = currentSecond;
                FOnTotalTimeChanged?.Invoke(lastSecond);
            }
           
        }

        // 게임 타이머 종료 시 처리
        GameEnd();
    }

    IEnumerator PlayTimerCount()
    {
        while (true)
        {
            yield return null;
            TotalPlayTime += Time.deltaTime;
        }
    }


    private void StopGameTimer(bool bisStop)
    {

        if (bisStop)
        {
            StopCoroutine(GameTimeCoroutine);
        }
        else
        {
            StartGameTimer();
        }
    }

    private void StopPlayTimer(bool bisStop)
    {
        if (bisStop)
        {
            StopCoroutine(PlayTimeCoroutine);
        }
        else
        {
           StartPlayTimer();
        }
    }


   
    public void CallBack_ChangeGeneration(int currentgeneration)
    {
        //세대 변경 됬을때 
        string generationname = objectManager.getCurrentGenerationName();
        PlayerHud.ChangeGenerationNameText(generationname);
        PlayerHud.OnForceRenewalBounusWidget();

        ufoplayer.MaxLevelLimitUp();
    }

    public void CallBack_StarSpawned(IDetctable targetstar)
    {
        PlayerHud.CallBack_AddDetectTarget(targetstar);
    }

    public void CallBack_StartSwallowed(StarObject star)
    {
        StarCnt++;

        //임시 소리 
        OnUfoSwallowSound();

        PlayerHud.CallBack_RemoveDetectTarget(star);
      
        PlayerHud.ChangeStarCntText(StarCnt);
        Destroy(star.gameObject);
    }

    public void OnUfoSwallowSound()
    {
        //임시 소리 
        ufoplayer.SwallowSound();
    }

    public void Skill_SetIgnoreBomb(bool active)
    {
        bIgnoredbomb = active;
    }
    public void Skill_SetIceActive(bool active)
    {
        bIceActive = active;

        objectManager.PauseSpawnObjects(active);
        objectManager.OnBombSpawn(active);

        StopGameTimer(active); 
    }

 
    public void AllObjectStopActive(bool active)
    {
        if (!active)
        {
            if (bIsGameEnd)
            {
                Debug.Log("이미 게임 끝남");
                return;

            }
        }
        objectManager.AllObjectStopActive(active);
       
        if (bIceActive)
            objectManager.IceActive(active);
      
    }

    public void GamePause(bool active)
    {
        objectManager.PauseSpawnObjects(active);
        AllObjectStopActive(active);
        StopGameTimer(  active );
        StopPlayTimer(  active );
        objectManager.OnBombSpawn(active);
    }
    

    public void GameEnd()
    {
       
        AllObjectStopActive(true);
        objectManager.StopSpawnObjects();
        objectManager.OnBombSpawn(false);
        bIsGameEnd = true;

        ufoplayer.CallBack_StopMovement();
        int converttime = Mathf.RoundToInt(TotalPlayTime);
        PlayerHud.UpdateGameState(converttime, TotalScore, StarCnt);

        SaveUserData();
    }

    private void SaveUserData()
    {
        GameManager.Instance.userData.AddStarCnt(StarCnt);
        GameManager.Instance.userData.UpdateBestScore(TotalScore);

        //스킬 카운트 업데이트
        for(int i=0;i<4;i++)
        {
            int cnt = AllSkillManager.ReadAllSkills[i].SkillCount;
            GameManager.Instance.userData.UpdateSkillCnt(i, cnt);
        }
       
        
        GameManager.Instance.SaveUserData();
    }

}
